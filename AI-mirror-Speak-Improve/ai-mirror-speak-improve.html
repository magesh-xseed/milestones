<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mirror Dashboard</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN for icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles to handle the primary color and hover effects globally */
        :root {
            --primary-color: #8a171d;
            --darker-color: #6d1116;
        }
        
        /* Apply custom colors using the variables where Tailwind can't easily interpolate from JS/JSX */
        .bg-primary { background-color: var(--primary-color); }
        .text-primary { color: var(--primary-color); }
        .border-primary { border-color: var(--primary-color); }
        .hover-bg-darker:hover { background-color: var(--darker-color); }
        .text-darker { color: var(--darker-color); }

        /* Ensure smooth scrolling for the report link */
        #report-section {
            scroll-margin-top: 20px;
        }

        /* Utility for line clamping */
        .line-clamp-1 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
        }
    </style>
</head>
<body class="font-sans">

    <div id="root" class="min-h-screen bg-gray-200 p-4 flex items-center justify-center">
        <!-- The application will render here -->
    </div>

    <script>
        // --- CONFIGURATION & MOCK DATA ---
        const PRIMARY_COLOR = '#8a171d'; // Deep Crimson
        const DARKER_COLOR = '#6d1116';
        const DEFAULT_TOPIC = "A quality education goes beyond textbooks and videos!";

        const RANDOM_TOPICS = [
            "Describe your favorite invention and why it matters.",
            "What is the most pressing environmental issue today and how can technology help solve it?",
            "Analyze the challenges and benefits of remote work.",
            "If you could have dinner with any historical figure, who would it be and why?",
            "Explain a complex idea (like blockchain or gravity) in simple terms.",
        ];

        const sessionReports = [
            {
                id: 1,
                date: 'Oct 20, 2025',
                topic: DEFAULT_TOPIC,
                overallScore: 'A-',
                scorePercentage: 92,
                summaryTip: "Excellent presentation! Focus next time on substituting basic conjunctions for more complex transition phrases to elevate your academic tone.",
                metrics: [
                    { title: 'Pronunciation', score: '88%', icon: 'Mic', color: 'text-yellow-600', detail: 'Mispronounced: comfortable, schedule' },
                    { title: 'Grammar', score: '2 Errors', icon: 'Zap', color: 'text-red-600', detail: 'Tip: Try: "I have been watching movies" instead of "I watching movies".' },
                    { title: 'Fluency', score: '1.2s Pause', icon: 'Clock', color: 'text-blue-600', detail: 'Goal: < 1.0s Pause Time' },
                    { title: 'Expression', score: '85% Eyes', icon: 'Award', color: 'text-green-600', detail: 'Consistent eye contact maintained.' },
                ],
                color: 'bg-green-100/70'
            },
            {
                id: 2,
                date: 'Oct 19, 2025',
                topic: 'Future of Work Trends',
                overallScore: 'B+',
                scorePercentage: 86,
                summaryTip: "Strong content organization! To reach an 'A' grade, reduce your use of filler words ('um', 'like').",
                metrics: [
                    { title: 'Pronunciation', score: '95%', icon: 'Mic', color: 'text-green-600', detail: 'Near perfect clarity.' },
                    { title: 'Grammar', score: '1 Error', icon: 'Zap', color: 'text-green-600', detail: 'Tip: Watch subject-verb agreement.' },
                    { title: 'Fluency', score: '2.5s Pause', icon: 'Clock', color: 'text-red-600', detail: 'Goal: < 1.0s Pause Time (major focus area).' },
                    { title: 'Expression', score: '60% Hands', icon: 'Award', color: 'text-yellow-600', detail: 'Overuse of hand gestures (distracting).' },
                ],
                color: 'bg-yellow-100/70'
            },
            {
                id: 3,
                date: 'Oct 18, 2025',
                topic: 'Weekend Plans Summary',
                overallScore: 'C+',
                scorePercentage: 74,
                summaryTip: "Start with a stronger hook and maintain a consistent pace. Your speed fluctuated too much.",
                metrics: [
                    { title: 'Pronunciation', score: '70%', icon: 'Mic', color: 'text-red-600', detail: 'Several common words mispronounced.' },
                    { title: 'Grammar', score: '5 Errors', icon: 'Zap', color: 'text-red-600', detail: 'Focus on sentence structure.' },
                    { title: 'Fluency', score: '1.0s Pause', icon: 'Clock', color: 'text-blue-600', detail: 'Acceptable pause time.' },
                    { title: 'Expression', score: '90% Eyes', icon: 'Award', color: 'text-green-600', detail: 'Excellent eye contact.' },
                ],
                color: 'bg-orange-100/70'
            },
        ];

        const mockTranscript = [
            { text: "A quality education ", highlight: null, tipId: null },
            { text: "goes beyond textbooks", highlight: 'red', tipId: 1, issue: 'Grammar' },
            { text: " and videos, it includes interactive training and real-time feedback. ", highlight: null, tipId: null },
            { text: "For example, [Pause 1.5s] ", highlight: 'blue', tipId: 2, issue: 'Fluency' },
            { text: "I believe that using an AI mirror system", highlight: null, tipId: null },
            { text: "is the better way to learn pronunciation and reduce my filler words.", highlight: 'yellow', tipId: 3, issue: 'Pronunciation' },
            { text: "It's a fantastic tool.", highlight: null, tipId: null },
        ];

        const tipsList = [
            { id: 1, type: 'Grammar', detail: 'Error: Use a singular verb "goes" with the singular subject "education". The subject-verb agreement is incorrect here.' },
            { id: 2, type: 'Fluency', detail: 'Excessive pause detected (1.5s). Maintain pace by planning transitions or using a transition phrase.' },
            { id: 3, type: 'Pronunciation', detail: 'Mispronounced "mirror" and "filler". Focus on the long "i" sound in "mirror" and reducing the harsh "r" in "filler".' },
        ];

        const iconMap = {
            'Award': 'award', 'Mic': 'mic', 'Zap': 'zap', 'BarChart3': 'bar-chart-3', 
            'Clock': 'clock', 'PlayCircle': 'play-circle', 'CheckCircle': 'check-circle', 
            'TrendingUp': 'trending-up', 'TrendingDown': 'trending-down', 'BookOpen': 'book-open', 
            'Edit': 'edit', 'AlertTriangle': 'alert-triangle', 'Volume2': 'volume-2', 
            'Pause': 'pause', 'Shuffle': 'shuffle', 'Info': 'info'
        };

        // --- STATE MANAGEMENT (Simplified for Vanilla JS) ---
        let state = {
            view: 'dashboard', // Start on dashboard, requiring button click to access camera
            sessionHistory: sessionReports,
            latestReport: sessionReports[0],
            currentTopic: DEFAULT_TOPIC,
            focusMode: null,
            showTranscriptModal: false,
            transcriptReport: null,
            overallScore: 'B+',
            isEditingTopic: false,
            tempTopic: DEFAULT_TOPIC,
            // NEW CAMERA STATES
            cameraStatus: 'Awaiting Activation', // 'Accessing', 'Active', 'Error:...'
            mediaStream: null,
        };

        // --- CAMERA STREAM FUNCTIONS ---

        /**
         * Requests camera access and starts the video stream.
         * Updates global state with status and stream object.
         */
        async function startCameraStream() {
            // 1. Update state to show 'Accessing' and re-render the status overlay
            updateState({ cameraStatus: 'Accessing', mediaStream: null });

            try {
                // Request video stream access (using 'user' for front camera and mirroring effect)
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' }
                });
                
                // Success
                updateState({ 
                    mediaStream: stream, 
                    cameraStatus: 'Active' 
                });

                // Crucial: Manually set the stream to the video element *after* render
                // This ensures the DOM has updated before we access the video element ID
                setTimeout(() => {
                    const videoElement = document.getElementById('liveCameraFeed');
                    if (videoElement) {
                        videoElement.srcObject = stream;
                        videoElement.play();
                    }
                }, 0); 

            } catch (error) {
                console.error('Camera Error:', error);
                let status = 'Error: Unknown';
                if (error.name === 'NotAllowedError') {
                    status = 'Error: Permission Denied. You must grant access in browser settings.';
                } else if (error.name === 'NotFoundError') {
                    status = 'Error: No camera found on this device.';
                } else if (error.name === 'NotReadableError') {
                    status = 'Error: Camera is in use by another application.';
                }
                updateState({ cameraStatus: status, mediaStream: null });
            }
        }

        /**
         * Stops all tracks on the media stream and cleans up the state.
         */
        function stopCameraStream() {
            if (state.mediaStream) {
                state.mediaStream.getTracks().forEach(track => track.stop());
            }
            updateState({ mediaStream: null, cameraStatus: 'Awaiting Activation' });
        }


        // --- UTILITY FUNCTIONS ---
        const updateState = (newState) => {
            state = { ...state, ...newState };
            renderApp(); // Re-render the application after any state change
        };

        const renderIcon = (iconName, className = '') => {
            const lucideName = iconMap[iconName] || iconName.toLowerCase();
            return `<i data-lucide="${lucideName}" class="${className}" style="width: 24px; height: 24px;"></i>`;
        };
        
        const scrollToReport = () => {
            setTimeout(() => {
                document.getElementById('report-section')?.scrollIntoView({ behavior: 'smooth' });
            }, 100); 
        };

        // --- COMPONENTS (HTML String Generators) ---

        const TranscriptModal = (report, onClose) => {
            if (!report) return '';

            const getHighlightClass = (highlight) => {
                if (highlight === 'red') return 'bg-red-200 border-red-500 font-semibold text-red-800 rounded-sm px-1 transition-all duration-100';
                if (highlight === 'blue') return 'bg-blue-200 border-blue-500 font-semibold text-blue-800 rounded-sm px-1 transition-all duration-100';
                if (highlight === 'yellow') return 'bg-yellow-200 border-yellow-500 font-semibold text-yellow-800 rounded-sm px-1 transition-all duration-100';
                return '';
            };

            const getColorClassForTip = (type) => {
                if (type === 'Grammar') return 'text-red-600 bg-red-100 border-red-300';
                if (type === 'Fluency') return 'text-blue-600 bg-blue-100 border-blue-300';
                if (type === 'Pronunciation') return 'text-yellow-600 bg-yellow-100 border-yellow-300';
                return 'text-gray-600 bg-gray-100 border-gray-300';
            };
            
            const fluencyMetric = report.metrics.find(m => m.title === 'Fluency');
            const worstMetric = report.metrics.reduce((min, current) => {
                // Find the first metric with a 'red' color, otherwise fallback to fluency.
                if (current.color.includes('red')) return current;
                return min;
            }, fluencyMetric); // Start min reduction with fluency

            // Annotated Transcript HTML generation
            const transcriptHTML = mockTranscript.map((item) => {
                const highlightClass = getHighlightClass(item.highlight);
                const tipAnchor = item.tipId 
                    ? `<a href="#tip-${item.tipId}" class="inline-flex items-center justify-center w-5 h-5 ml-1 text-xs font-bold text-white rounded-full bg-darker hover:bg-primary leading-none shadow-md transition duration-150">${item.tipId}</a>` 
                    : '';
                return `<span class="inline transition-colors duration-100 ${highlightClass}">${item.text}${tipAnchor}</span>`;
            }).join('');

            // Tips Summary HTML generation
            const tipsSummaryHTML = tipsList.map((tip) => {
                const colorClass = getColorClassForTip(tip.type);
                return `
                    <div key="${tip.id}" id="tip-${tip.id}" class="p-3 border rounded-xl shadow-sm bg-white">
                        <div class="flex items-start">
                            <div class="flex items-center justify-center w-6 h-6 mr-3 text-xs font-bold rounded-full border-2 ${colorClass}">
                                ${tip.id}
                            </div>
                            <div class="flex-1">
                                <p class="font-bold text-sm ${colorClass} leading-none">
                                ${tip.type}
                                </p>
                                <p class="text-sm text-gray-700 mt-1">${tip.detail}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
                    <div class="bg-white w-full max-w-md h-full max-h-[700px] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                        
                        <!-- Header -->
                        <div class="p-5 bg-primary text-white flex justify-between items-center shadow-lg">
                            <h2 class="text-xl font-bold flex items-center">
                                ${renderIcon('BookOpen', 'h-5 w-5 mr-2')}
                                Full Transcript Review
                            </h2>
                            <button onclick="updateState({showTranscriptModal: false, transcriptReport: null})" class="text-white hover:text-gray-300 font-bold text-2xl leading-none">
                                &times;
                            </button>
                        </div>

                        <!-- Content Area -->
                        <div class="p-4 overflow-y-auto flex-1">
                            <p class="text-sm font-semibold text-gray-600 mb-3 border-b pb-2">Topic: ${report.topic}</p>

                            <!-- Key Issue Summary -->
                            <div class="bg-red-50 border-l-4 border-red-400 p-3 mb-4 rounded-lg">
                                <p class="text-red-700 font-bold flex items-center">
                                    ${renderIcon('AlertTriangle', 'h-4 w-4 mr-2')}
                                    Top Focus Area: ${worstMetric.title}
                                </p>
                                <p class="text-red-600 text-sm mt-1">${worstMetric.detail}</p>
                            </div>
                            
                            <!-- Legend/Key -->
                            <div class="flex justify-between items-center text-xs text-gray-600 p-2 bg-gray-100 rounded-lg mb-4 shadow-inner">
                                <span class="flex items-center">
                                    <span class="w-2 h-2 rounded-full bg-red-500 mr-1"></span> Grammar
                                </span>
                                <span class="flex items-center">
                                    <span class="w-2 h-2 rounded-full bg-blue-500 mr-1"></span> Fluency
                                </span>
                                <span class="flex items-center">
                                    <span class="w-2 h-2 rounded-full bg-yellow-500 mr-1"></span> Pronunciation
                                </span>
                            </div>

                            <!-- Annotated Transcript -->
                            <h3 class='text-lg font-bold text-gray-800 mb-2'>Annotated Transcript</h3>
                            <div class="leading-relaxed text-gray-700 text-base mb-6">
                                <div class="inline">
                                    ${transcriptHTML}
                                </div>
                                <p class="text-xs text-gray-400 mt-4 text-center border-t pt-2">--- End of Recorded Speech ---</p>
                            </div>
                            
                            <!-- Summary of Tips -->
                            <h3 class='text-lg font-bold text-gray-800 mb-3 mt-4 border-t pt-4'>Summary of Tips (${tipsList.length} Issues Found)</h3>
                            <div class="space-y-3">
                                ${tipsSummaryHTML}
                            </div>
                        </div>
                        
                        <!-- Footer/Close Button -->
                        <div class="p-4 border-t border-gray-200">
                            <button
                                onclick="updateState({showTranscriptModal: false, transcriptReport: null})"
                                class="w-full py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold rounded-lg"
                            >
                                Close Review
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };


        const TrendCard = (title, value, change) => `
            <div class="flex flex-col items-start p-4 bg-white rounded-xl shadow-lg w-full">
                <div class="text-sm font-semibold ${change > 0 ? 'text-green-600' : 'text-red-600'} flex items-center">
                    ${change > 0 ? renderIcon('TrendingUp', 'h-4 w-4 mr-1') : renderIcon('TrendingDown', 'h-4 w-4 mr-1')}
                    ${Math.abs(change)}%
                </div>
                <div class="text-3xl font-bold mt-1 text-gray-800">${value}</div>
                <div class="text-gray-500 text-xs mt-1">${title}</div>
            </div>
        `;

        const MockChart = () => {
            const barHeights = [40, 55, 60, 80, 75, 90, 85, 92, 95, 90];
            const barsHTML = barHeights.map((height, index) => `
                <div
                    style="height: ${height}%; width: 8%; background-color: var(--primary-color);"
                    class="rounded-t-lg transition-all duration-500 ease-out hover:opacity-80"
                    title="Session ${index + 1}: ${height}%"
                ></div>
            `).join('');
            
            return `
                <div class="h-48 bg-gray-100 p-4 rounded-xl flex flex-col justify-end relative shadow-inner">
                    <span class="absolute top-2 left-3 text-lg font-bold text-gray-700">Fluency Score (%)</span>
                    <div class="flex justify-between items-end h-full pt-6">
                        ${barsHTML}
                    </div>
                    <div class="text-xs text-gray-500 mt-2 flex justify-between">
                        <span>S1</span><span>S3</span><span>S5</span><span>S7</span><span>S9</span>
                    </div>
                </div>
            `;
        };
        
        // --- SCREEN GENERATORS ---

        const CameraScreen = (topic, focusMode) => {
            const isCameraActive = state.cameraStatus === 'Active';
            const isError = state.cameraStatus.startsWith('Error');
            const isLoading = state.cameraStatus === 'Accessing';

            return `
                <div class="relative h-full bg-black flex flex-col items-center justify-end p-8">
                    
                    <!-- Video Element (Actual Camera Feed) -->
                    <video 
                        id="liveCameraFeed" 
                        class="absolute inset-0 w-full h-full object-cover z-0 transform scale-x-[-1]" 
                        autoplay 
                        playsinline 
                        muted
                        style="${isCameraActive ? 'display: block;' : 'display: none;'}"
                    ></video>

                    <!-- Status Overlay (Shown when not active) -->
                    <div class="absolute inset-0 bg-gray-900/90 flex items-center justify-center z-10" 
                        style="${isCameraActive ? 'display: none;' : 'display: flex;'}"
                    >
                        <div class="text-center text-white p-4">
                            ${isLoading ? `<svg class="animate-spin h-10 w-10 text-white mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>` : ''}
                            
                            <p class="text-2xl font-bold mb-2">${state.cameraStatus}</p>
                            ${isError ? 
                                `<p class="text-sm text-red-300">Click the button below to return to the dashboard and try again.</p>` : 
                                `<p class="text-sm opacity-80">Please grant camera permission in your browser.</p>`
                            }
                        </div>
                    </div>


                    <!-- Top Prompt Overlay -->
                    <div class="absolute top-0 w-full p-4 bg-black/40 text-center z-20">
                        <p class="text-white text-sm opacity-80">
                            ${focusMode ? `FOCUSED DRILL: ${focusMode}` : 'Prompt:'}
                        </p>
                        <p class="text-white font-medium">${topic}</p>
                    </div>

                    <!-- Real-time Metrics (Simulated) -->
                    <div class="w-full flex justify-around p-4 mb-8 bg-black/40 rounded-xl relative z-20">
                        <div class="flex flex-col items-center">
                            <p class="text-4xl font-black ${isCameraActive ? 'text-green-400' : 'text-gray-400'}">00:15</p>
                            <p class="text-xs text-white opacity-80">Timer (Max 2:00)</p>
                        </div>
                        <div class="flex flex-col items-center">
                            <p class="text-4xl font-black text-white">45</p>
                            <p class="text-xs text-white opacity-80">Words Spoken</p>
                        </div>
                    </div>

                    <!-- Stop Button - Calls handleStopRecording which updates view state -->
                    <button
                        onclick="handleStopRecording()"
                        class="w-20 h-20 bg-primary hover-bg-darker rounded-full shadow-2xl transition duration-150 flex items-center justify-center border-4 border-white/50 relative z-20"
                        title="Stop Recording"
                    >
                        <span class="w-8 h-8 bg-white rounded-md"></span>
                    </button>
                    <p class="text-white text-sm mt-3 relative z-20">Tap to End Session</p>
                </div>
            `;
        };

        const ProcessingScreen = () => `
            <div class="flex flex-col h-full items-center justify-center bg-gray-900 text-white p-6">
                <svg class="animate-spin h-12 w-12 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <h2 class="text-2xl font-bold mt-4">Analyzing Performance...</h2>
                <p class="text-sm mt-2 opacity-75">Processing video, audio, and body language via AI Engine.</p>
            </div>
        `;
        
        // --- DASHBOARD SECTIONS ---

        const IntroductionSection = (currentTopic, overallScore, isEditing, tempTopic) => {
            return `
                <div class="p-6 pb-8 bg-gray-50">
                    <h1 class="text-3xl font-extrabold text-gray-900 mb-6">AI Mirror Dashboard</h1>
                    
                    <!-- Overall Score -->
                    <div class="bg-primary text-white p-6 rounded-2xl shadow-xl mb-6 relative">
                        
                        <!-- Grade Info Icon and Tooltip -->
                        <div class="absolute top-4 right-4 group">
                            ${renderIcon('Info', 'h-5 w-5 text-white cursor-pointer opacity-70 hover:opacity-100 transition-opacity')}
                            <div class="absolute right-0 top-7 w-72 bg-white text-gray-800 p-4 rounded-xl shadow-2xl text-sm opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20 transform translate-x-1">
                                <h4 class="font-bold border-b pb-1 mb-2 text-md">Overall Grade Breakdown</h4>
                                <div class="space-y-1">
                                    <div class="flex justify-between font-semibold"><span>A/A+</span><span class="text-green-600">93% - 100%</span></div>
                                    <div class="flex justify-between"><span>B+ / B</span><span class="text-yellow-600">83% - 89%</span></div>
                                    <div class="flex justify-between"><span>C+ / C</span><span class="text-red-600">70% - 82%</span></div>
                                    <div class="flex justify-between"><span>D / F</span><span class="text-red-700"> &lt; 70%</span></div>
                                </div>
                                <p class="mt-2 text-xs italic text-gray-500 border-t pt-2">
                                    Your <b>${overallScore}</b> average indicates above-average performance with room for improvement in specific metrics like Fluency.
                                </p>
                            </div>
                        </div>
                        <!-- End Grade Info -->

                        <p class="text-sm font-light opacity-80">Overall Speaking Average</p>
                        <p class="text-6xl font-black mt-1">${overallScore}</p>
                        <p class="text-sm font-light mt-2">Current Grade (Based on last 5 sessions)</p>
                    </div>

                    <!-- Topic Card (Editable) -->
                    <div class="bg-white p-5 rounded-xl shadow-md border-t-4 border-gray-300 mb-8">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-lg font-semibold text-gray-700">Practice Topic</h2>
                            
                            <!-- Button Group for Randomize and Edit -->
                            <div class='flex space-x-3'>
                                <button 
                                    onclick="handleRandomizeTopic()" 
                                    class="text-gray-500 hover:text-darker text-sm font-medium flex items-center transition duration-150 ${state.isEditingTopic ? 'opacity-50 cursor-not-allowed' : 'text-primary'}"
                                    title="Generate Random Topic"
                                    ${state.isEditingTopic ? 'disabled' : ''}
                                >
                                    ${renderIcon('Shuffle', 'h-4 w-4')}
                                </button>
                                <button 
                                    onclick="handleEditToggle()" 
                                    class="text-primary hover:text-darker text-sm font-medium flex items-center"
                                >
                                    ${renderIcon('Edit', 'h-4 w-4 mr-1')}
                                    ${state.isEditingTopic ? 'Cancel' : 'Edit'}
                                </button>
                            </div>
                        </div>
                        
                        ${state.isEditingTopic ? (
                            `
                            <textarea
                                id="topic-input"
                                onchange="updateState({tempTopic: this.value})"
                                class="w-full text-gray-900 text-xl font-medium leading-relaxed border border-gray-300 rounded p-2 focus:ring-2 focus:ring-primary resize-none"
                                rows="3"
                            >${state.tempTopic}</textarea>
                            <button
                                onclick="handleSaveTopic()"
                                class="mt-3 w-full py-2 bg-primary text-white font-bold rounded-lg hover-bg-darker"
                            >
                                Save Topic
                            </button>
                            `
                        ) : (
                            `<p class="text-gray-900 text-xl font-medium leading-relaxed">${state.currentTopic}</p>`
                        )}
                    </div>

                    <!-- Start Button -->
                    <button
                        onclick="handleStartSession()"
                        class="w-full py-4 bg-primary hover-bg-darker text-white font-bold text-lg rounded-full shadow-2xl transition duration-150 transform hover:scale-[1.01] flex items-center justify-center"
                    >
                        ${renderIcon('PlayCircle', 'mr-2 h-6 w-6')}
                        Start New Speaking Session
                    </button>
                </div>
            `;
        };

        const FocusAreaSection = (latestReport) => {
            const fluencyMetric = latestReport.metrics.find(m => m.title === 'Fluency');
            // Determine the worst metric: the first one marked red, otherwise Fluency as a default focus area
            const worstMetric = latestReport.metrics.reduce((min, current) => {
                if (current.color.includes('red')) return current;
                return min;
            }, fluencyMetric);

            return `
                <div class="p-6 bg-gray-100 border-t border-gray-100">
                    <h1 class="text-2xl font-extrabold text-gray-900 mb-4 flex items-center">
                        ${renderIcon('AlertTriangle', 'h-6 w-6 mr-2 text-red-600')}
                        Your Improvement Focus
                    </h1>
                    
                    <!-- Redesigned Focus Card for High Impact -->
                    <div class="bg-white p-5 rounded-xl shadow-lg border-l-8 border-primary">
                        <div class="flex items-center justify-between mb-3 border-b border-gray-100 pb-2">
                            <p class="text-xl font-bold text-gray-800 flex items-center">
                                ${renderIcon('Zap', 'h-6 w-6 mr-2 text-red-600')}
                                ${worstMetric.title}
                            </p>
                            <span class="text-sm font-semibold text-red-600 px-3 py-1 rounded-full bg-red-100 shadow-sm">
                                CRITICAL
                            </span>
                        </div>
                        
                        <p class="text-gray-700 leading-relaxed mb-4 text-sm">
                            Based on your last session score of <span class="font-bold text-lg text-red-700">${latestReport.overallScore}</span>, <span class="font-bold">${worstMetric.title}</span> remains your weakest area.
                        </p>

                        <div class="p-3 bg-red-50 rounded-lg">
                            <p class="font-bold text-red-700 text-base">
                                Actionable Step:
                            </p>
                            <p class="text-red-700 font-medium text-sm mt-1">
                                ${worstMetric.detail}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Prominent Action Button -->
                    <button
                        onclick="handleStartDrill('${worstMetric.title}')"
                        class="mt-6 w-full py-3 bg-primary hover-bg-darker text-white font-bold text-lg rounded-full shadow-lg transition duration-150 transform hover:scale-[1.01]"
                    >
                        Start Focused Practice Drill
                    </button>
                </div>
            `;
        };
        
        const ReportSection = (report) => {
            const metricsHTML = report.metrics.map((metric) => `
                <div class="bg-white p-5 rounded-xl shadow-lg flex items-center space-x-4 border border-gray-100">
                    ${renderIcon(metric.icon, `h-8 w-8 ${metric.color}`)}
                    <div>
                        <p class="text-sm font-semibold text-gray-600">${metric.title}</p>
                        <p class="text-2xl font-black text-gray-900">${metric.score}</p>
                        <p class="text-xs text-gray-500 mt-1">${metric.detail}</p>
                    </div>
                </div>
            `).join('');

            return `
                <div id="report-section" class="p-6 bg-white border-t border-gray-100 shadow-inner">
                    <h1 class="text-3xl font-extrabold text-gray-900 mb-2">
                        ${report.id === sessionReports[0].id ? 'Latest Session Report' : 'Session Review'} 
                    </h1>
                    <p class="text-gray-500 mb-6">Topic: ${report.topic} <span class="font-semibold ml-2">(${report.date})</span></p>

                    <!-- Overall Score Block -->
                    <div class="bg-primary text-white p-6 rounded-2xl shadow-xl mb-6 flex justify-between items-center">
                        <div>
                            <p class="text-sm font-light opacity-80">Final Performance Score</p>
                            <p class="text-7xl font-black mt-1">${report.overallScore}</p>
                        </div>
                        <div class="flex flex-col items-end">
                            ${renderIcon('CheckCircle', 'h-10 w-10 text-white')}
                            <p class="text-lg mt-1 font-semibold">${report.scorePercentage}%</p>
                        </div>
                    </div>

                    <!-- Summary Tip -->
                    <div class="bg-gray-50 p-4 rounded-xl shadow-md border-l-4 border-indigo-500 mb-6">
                        <p class="text-sm font-semibold text-darker mb-1">AI Summary:</p>
                        <p class="text-gray-700 italic leading-relaxed">"${report.summaryTip}"</p>
                    </div>

                    <!-- Detailed Metrics -->
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Detailed Breakdown</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${metricsHTML}
                    </div>
                    <!-- Transcript Button -->
                    <button
                        onclick="handleOpenTranscriptModal(${report.id})"
                        class="mt-6 w-full py-3 font-bold text-lg rounded-full transition duration-150 shadow-sm flex items-center justify-center bg-gray-200 hover:bg-gray-300 text-gray-800"
                    >
                        ${renderIcon('BookOpen', 'mr-2 h-5 w-5')}
                        View Full Transcript & Tips
                    </button>
                </div>
            `;
        };

        const ProgressSection = (history) => {
            const historyHTML = history.map((session) => `
                <div key="${session.id}" class="flex items-center p-4 bg-white rounded-xl shadow-sm border border-gray-100">
                    <div class="w-12 h-12 flex items-center justify-center rounded-full font-bold text-xl ${session.color} border border-gray-200">
                        ${session.overallScore}
                    </div>
                    <div class="ml-4 flex-1">
                        <p class="font-semibold text-gray-900 line-clamp-1">${session.topic}</p>
                        <p class="text-sm text-gray-500">${session.date}</p>
                    </div>
                    <button 
                        onclick="handleViewReport(${session.id})" 
                        class="text-primary text-sm font-medium hover:opacity-80 flex items-center"
                    >
                        Review Report
                    </button>
                </div>
            `).join('');

            return `
                <div class="p-6 bg-gray-50 border-t border-gray-200">
                    <h1 class="text-3xl font-extrabold text-gray-900 mb-6">Long-Term Progress</h1>
                    
                    <!-- Trends -->
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        ${TrendCard("Overall Score", "B+", 5)}
                        ${TrendCard("Unique Words", "â†‘ 15%", 15)}
                    </div>

                    <!-- Chart Section -->
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        ${renderIcon('BarChart3', 'w-5 h-5 mr-2 text-primary')}
                        Last 10 Sessions Performance
                    </h2>
                    <div class="bg-white p-4 rounded-xl shadow-lg mb-8">
                        ${MockChart()}
                    </div>

                    <!-- History -->
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Session History</h2>
                    <div class="space-y-3 pb-4">
                        ${historyHTML}
                    </div>
                </div>
            `;
        };

        // --- HANDLERS (State Modifiers) ---

        const handleEditToggle = () => {
            if (state.isEditingTopic) {
                // Cancel: revert tempTopic, close editor
                updateState({ isEditingTopic: false, tempTopic: state.currentTopic });
            } else {
                // Edit: start editing, sync tempTopic
                updateState({ isEditingTopic: true, tempTopic: state.currentTopic });
            }
        };

        const handleSaveTopic = () => {
            const inputElement = document.getElementById('topic-input');
            const newTopic = inputElement ? inputElement.value : state.currentTopic;
            updateState({ currentTopic: newTopic, isEditingTopic: false });
        };
        
        const handleRandomizeTopic = () => {
            if (state.isEditingTopic) return;
            const randomIndex = Math.floor(Math.random() * RANDOM_TOPICS.length);
            const newTopic = RANDOM_TOPICS[randomIndex];
            updateState({ currentTopic: newTopic, tempTopic: newTopic, isEditingTopic: false });
        };

        const handleStartSession = () => {
            updateState({ focusMode: null, latestReport: sessionReports[0], view: 'camera' });
            startCameraStream(); // <-- Start camera when session begins
        };
        
        const handleStartDrill = (drillMetric) => {
            updateState({ focusMode: drillMetric, latestReport: sessionReports[0], view: 'camera' });
            startCameraStream(); // <-- Start camera when drill begins
        };

        const handleStopRecording = () => {
            stopCameraStream(); // <-- Stop camera before processing
            updateState({ view: 'processing' });
            
            // Simulate new session report generation
            setTimeout(() => {
                const newReport = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                    topic: state.currentTopic,
                    overallScore: state.focusMode ? 'A+' : 'A',
                    scorePercentage: state.focusMode ? 98 : 96,
                    summaryTip: state.focusMode 
                        ? `Outstanding focus on ${state.focusMode}! You successfully integrated all practice tips.`
                        : "Phenomenal delivery! You hit all targets. Next, explore using complex rhetorical questions to engage the audience deeper.",
                    metrics: [
                        { title: 'Pronunciation', score: '99%', icon: 'Mic', color: 'text-green-600', detail: 'Perfect clarity.' },
                        { title: 'Grammar', score: '0 Errors', icon: 'Zap', color: 'text-green-600', detail: 'Flawless structure.' },
                        { title: 'Fluency', score: '0.8s Pause', icon: 'Clock', color: 'text-green-600', detail: 'Met pause time goal.' },
                        { title: 'Expression', score: '95% Energy', icon: 'Award', color: 'text-green-600', detail: 'Dynamic and engaging tone.' },
                    ],
                    color: 'bg-green-100/70'
                };

                // Add the new report to the history (at the beginning)
                const newHistory = [newReport, ...state.sessionHistory];
                
                // Recalculate the overall score average (simplified, using the last 5 reports)
                const scoreSum = newHistory.slice(0, 5).reduce((sum, report) => sum + report.scorePercentage, 0);
                const scoreAvg = scoreSum / Math.min(newHistory.length, 5);
                let overallScoreLetter = 'A';
                if (scoreAvg < 93 && scoreAvg >= 87) overallScoreLetter = 'A-';
                else if (scoreAvg < 87 && scoreAvg >= 83) overallScoreLetter = 'B+';
                else if (scoreAvg < 83 && scoreAvg >= 70) overallScoreLetter = 'B';
                else if (scoreAvg < 70) overallScoreLetter = 'C+';


                updateState({
                    sessionHistory: newHistory,
                    latestReport: newReport,
                    focusMode: null,
                    view: 'dashboard',
                    overallScore: overallScoreLetter 
                });
                scrollToReport();

            }, 2500); // 2.5 seconds processing time
        };

        const handleViewReport = (reportId) => {
            // Stop camera if somehow still running when viewing a report
            stopCameraStream(); 
            const report = state.sessionHistory.find(r => r.id === reportId);
            if (report) {
                updateState({ latestReport: report });
                scrollToReport();
            }
        };
        
        const handleOpenTranscriptModal = (reportId) => {
            const report = state.sessionHistory.find(r => r.id === reportId);
            if (report) {
                updateState({ transcriptReport: report, showTranscriptModal: true });
            }
        };

        // --- MAIN RENDER FUNCTION ---
        const renderApp = () => {
            const appContainer = document.getElementById('root');
            let contentHTML = '';

            if (state.view === 'camera') {
                contentHTML = CameraScreen(state.currentTopic, state.focusMode);
            } else if (state.view === 'processing') {
                contentHTML = ProcessingScreen();
            } else {
                // Dashboard View
                contentHTML = `
                    <main class="flex-1 overflow-y-auto">
                        ${IntroductionSection(state.currentTopic, state.overallScore, state.isEditingTopic, state.tempTopic)}
                        ${FocusAreaSection(state.latestReport)}
                        ${ReportSection(state.latestReport)}
                        ${ProgressSection(state.sessionHistory)}
                        <div class="h-10"></div>
                    </main>
                `;
            }

            // Outer container (Simulated device frame)
            let fullHTML = `
                <div class="w-full max-w-sm h-[800px] bg-white rounded-[40px] shadow-2xl overflow-hidden flex flex-col relative">
                    ${contentHTML}
                </div>
            `;
            
            // Render Modal
            if (state.showTranscriptModal && state.transcriptReport) {
                fullHTML += TranscriptModal(state.transcriptReport);
            }

            appContainer.innerHTML = fullHTML;
            
            // Re-initialise Lucide icons after DOM update
            lucide.createIcons();
        };

        // Initial render
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize state.tempTopic to match initial state.currentTopic
            state.tempTopic = state.currentTopic;
            renderApp();
        });
    </script>
</body>
</html>
